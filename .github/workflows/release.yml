name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build rotation
        run: node rotation/build.js

      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: rotation/output/diddy aio.lua

      - name: Notify Discord
        if: success()
        continue-on-error: true
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          GH_TOKEN: ${{ github.token }}
        run: |
          NOTES=$(gh api "repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}" --jq '.body // empty' 2>/dev/null || echo "")
          BODY=$(jq -nc \
            --arg tag "${{ github.ref_name }}" \
            --arg repo "${{ github.repository }}" \
            --arg actor "${{ github.actor }}" \
            --arg now "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg notes "${NOTES:-Release ${{ github.ref_name }} is now available.}" \
            '{
              action: "published",
              release: {
                tag_name: $tag,
                name: $tag,
                html_url: "https://github.com/\($repo)/releases/tag/\($tag)",
                body: $notes,
                published_at: $now,
                author: {
                  login: $actor,
                  avatar_url: "https://github.com/\($actor).png",
                  html_url: "https://github.com/\($actor)"
                }
              }
            }')
          SIG="sha256=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | awk '{print $2}')"
          curl -s -X POST "http://${VPS_HOST}:3000/webhook/github" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: ${SIG}" \
            -H "X-GitHub-Event: release" \
            -d "$BODY"
